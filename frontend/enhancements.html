<!-- Enhanced Frontend Features -->
<script>
// Add to your existing JavaScript

// Real-time typing indicator
function showTypingIndicator() {
    const responseArea = document.getElementById('response');
    responseArea.innerHTML = `
        <div class="typing-indicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
            <p>AI is analyzing your legal query...</p>
        </div>
    `;
}

// Enhanced form validation
function validateForm() {
    const query = document.getElementById('query').value.trim();
    const category = document.getElementById('category').value;
    
    if (query.length < 10) {
        showError('Please provide a more detailed legal query (minimum 10 characters)');
        return false;
    }
    
    if (query.length > 5000) {
        showError('Query too long. Please limit to 5000 characters.');
        return false;
    }
    
    // Check for potentially sensitive information
    const sensitivePatterns = [
        /\b\d{10,}\b/, // Phone numbers
        /\b\d{3}-\d{2}-\d{4}\b/, // SSN patterns
        /\b[A-Z]{5}\d{4}[A-Z]{1}\b/ // PAN card patterns
    ];
    
    for (let pattern of sensitivePatterns) {
        if (pattern.test(query)) {
            if (!confirm('Your query may contain sensitive information. Are you sure you want to proceed?')) {
                return false;
            }
            break;
        }
    }
    
    return true;
}

// Auto-save draft functionality
function autoSaveDraft() {
    const query = document.getElementById('query').value;
    const category = document.getElementById('category').value;
    
    if (query.length > 10) {
        localStorage.setItem('legalBotDraft', JSON.stringify({
            query: query,
            category: category,
            timestamp: new Date().toISOString()
        }));
    }
}

// Restore draft on page load
function restoreDraft() {
    const draft = localStorage.getItem('legalBotDraft');
    if (draft) {
        try {
            const draftData = JSON.parse(draft);
            const draftAge = new Date() - new Date(draftData.timestamp);
            
            // Only restore if draft is less than 1 hour old
            if (draftAge < 3600000) {
                document.getElementById('query').value = draftData.query;
                document.getElementById('category').value = draftData.category;
                
                // Show restoration notice
                showInfo('Previous draft restored. You can continue editing or clear to start fresh.');
            }
        } catch (e) {
            console.log('Could not restore draft:', e);
        }
    }
}

// Character counter
function updateCharacterCount() {
    const query = document.getElementById('query').value;
    const counter = document.getElementById('char-counter');
    const remaining = 5000 - query.length;
    
    counter.textContent = `${query.length}/5000 characters`;
    counter.style.color = remaining < 100 ? '#ef4444' : '#6b7280';
}

// Feedback system
function submitFeedback(consultationId, rating) {
    fetch('/api/v1/feedback', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            consultation_id: consultationId,
            rating: rating,
            feedback: document.getElementById('feedback-text')?.value || ''
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess('Thank you for your feedback!');
        } else {
            showError('Failed to submit feedback. Please try again.');
        }
    })
    .catch(error => {
        showError('Error submitting feedback: ' + error.message);
    });
}

// Initialize enhancements
document.addEventListener('DOMContentLoaded', function() {
    restoreDraft();
    
    // Auto-save every 30 seconds
    setInterval(autoSaveDraft, 30000);
    
    // Add character counter
    const queryTextarea = document.getElementById('query');
    if (queryTextarea) {
        queryTextarea.addEventListener('input', updateCharacterCount);
        
        // Add character counter element
        const counterDiv = document.createElement('div');
        counterDiv.innerHTML = '<span id="char-counter">0/5000 characters</span>';
        counterDiv.className = 'character-counter';
        queryTextarea.parentNode.appendChild(counterDiv);
    }
});
</script>

<style>
.typing-indicator {
    text-align: center;
    padding: 20px;
}

.typing-dots {
    display: inline-block;
    margin-bottom: 10px;
}

.typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #3b82f6;
    margin: 0 2px;
    animation: typing 1.4s infinite both;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

.character-counter {
    text-align: right;
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 5px;
}

.feedback-section {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background-color: #f9fafb;
}

.rating-stars {
    display: flex;
    gap: 5px;
    margin: 10px 0;
}

.rating-stars button {
    background: none;
    border: none;
    font-size: 24px;
    color: #d1d5db;
    cursor: pointer;
    transition: color 0.2s;
}

.rating-stars button:hover,
.rating-stars button.active {
    color: #fbbf24;
}
</style>
